{% extends "base.html" %}
{% load static %}

{% block title %}
    Visualizer
{% endblock %}

{% block css %}
    <link href="{% static 'visualizer.css' %}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/molstar@4.12.1/build/viewer/molstar.min.css" rel="stylesheet">
{% endblock %}

{% block body %}

<div id="viewer" style="position: relative; width: 500px; height: 500px;"></div>

{% endblock %}

{% block js %}
    <script src="https://cdn.jsdelivr.net/npm/molstar@4.12.1/build/viewer/molstar.min.js"></script>
    <script>
        // Build an ad-hoc MVS view
        // Try and get URL from ?url=
        let url = new URLSearchParams(window.location.search).get('url');
        let format = new URLSearchParams(window.location.search).get('format');
        console.log(url, format)
        if (!url) {
            url = 'https://www.ebi.ac.uk/pdbe/entry-files/1cbs.bcif';
            format = 'bcif';
        }
        if (!format) {
            format = 'pdb';
        }
        console.log(url, format)
        const builder = molstar.PluginExtensions.mvs.MVSData.createBuilder();
        const structure = builder
            .download({ url: url })
            .parse({ format: format })
            .modelStructure({});
        structure
            .component({ selector: 'polymer' })
            .representation({ type: 'cartoon' })
            .color({ color: 'green' });

        // make the color depend on pLDDT Confidence
        {% comment %} structure
            .component({ selector: 'ligand' })
            .label({ text: 'Retinoic acid' })
            .focus({})
            .representation({ type: 'ball_and_stick' })
            .color({ color: '#cc3399' }); {% endcomment %}
        const mvsData = builder.getState();

        // Initialize viewer and load MVSJ
        const mvsj = molstar.PluginExtensions.mvs.MVSData.toMVSJ(mvsData);
        molstar.Viewer.create('viewer', { layoutIsExpanded: false, layoutShowControls: false })
            .then(viewer => viewer.loadMvsData(mvsj, 'mvsj'));

        // // Alternative initialization and loading (avoids encoding and again decoding the data, allows changing the view by using `replaceExisting: true`):
        // molstar.Viewer.create('viewer2', { layoutIsExpanded: false, layoutShowControls: false })
        //     .then(viewer => molstar.PluginExtensions.mvs.loadMVS(viewer.plugin, mvsData, { sourceUrl: undefined, sanityChecks: true, replaceExisting: false }));
    
        
        let viewer = $('#viewer');
        viewer.css({
            position: 'absolute',
            left: 0,
            width: '100vw',
            height: '92vh',
        });

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        $(async function() {
            let sleep_time = 5;
            await sleep(100);
            $("button.msp-btn.msp-btn-icon.msp-btn-link-toggle-off[title='Toggle Controls Panel']").click()
            await sleep(sleep_time);
            $("button.msp-btn.msp-btn-icon.msp-form-control[title='Actions']").click()
            await sleep(sleep_time);
            $("button.msp-btn.msp-form-control.msp-btn-block").click()
            await sleep(sleep_time);
            $("button.msp-btn.msp-btn-block[title='Uniform']").click()
            await sleep(sleep_time);
            $("button.msp-btn.msp-btn-block.msp-no-overflow[title='Click to expand. Validation']").click()
            await sleep(sleep_time);
            $("button.msp-btn.msp-btn-block.msp-no-overflow.msp-action-menu-button").filter(
                function() {
                    return $(this).text() === 'pLDDT Confidence';
                }
            ).click();
            await sleep(sleep_time);
            $("button.msp-btn.msp-btn-icon.msp-btn-link-toggle-on[title='Toggle Controls Panel']").click()
            await sleep(20);
            $("#viewer").show();
        });

    </script>
    <script src="{% static 'visualizer.js' %}"></script>
{% endblock %}